---
title: "Proyecto de análisis de datos de una compañía de telecomunicaciones"
author: "Sandra Gálvez Begines"
output:
  pdf_document: default
  html_document: default
---



__El objetivo de este proyecto es realizar un análisis de datos del conjunto "Telco Customer Churn". En él se explorará el conjunto de datos para analizar los factores que influyen en la tasa de abandono de los clientes de una empresa de telecomunicaciones. Predecir por un lado, el gasto de los clientes y por otro lado predecir los clientes en riesgo de cambiar de compañía en el mes en curso y realizar un modelo predictivo y una simulación de una campaña para retener a los clientes.__

-----------------------------------------------------------------------------------------------

## Descripción

La tasa de abandono de clientes, también conocida como "churn" en inglés, es una métrica fundamental para las empresas de servicios. Se refiere a la cantidad de clientes que dejan de utilizar los servicios de una empresa en un período de tiempo dado. Esta métrica es esencial porque atraer nuevos clientes suele ser más costoso que mantener a los clientes existentes. En otras palabras, retener a los clientes es más rentable que adquirir nuevos.

En este proyecto, se utilizará un conjunto de datos llamado "Telco Customer Churn" y se aplicarán herramientas, técnicas de análisis de datos y modelado predictivo para comprender mejor por qué los clientes abandonan el servicio. Algunas de las preguntas que se intentarán responder son:

 * ¿Cuáles son los motivos que llevan a los clientes a abandonar el servicio?
 * ¿Existe alguna relación entre el tiempo de contrato y la probabilidad de abandono?
 * ¿Cómo influye el tipo de servicio contratado en la tasa de abandono?
 * ¿Cuán precisos son los modelos predictivos para identificar a los clientes más propensos a     abandonar?
 * ¿Qué campaña se ajusta más para evitar el abandono de nuestros clientes?
 
Para abordar estas cuestiones, se llevará a cabo un análisis exploratorio completo del conjunto de datos para poder descubrir anomalías en los datos y descubrir patrones que relacionen a las distintas variables
- Modelos de regresión: Diseñaremos y ajustaremos modelos de regresión lineal para
predecir el gasto mensual de los clientes (MonthlyCharges) a partir de los servicios
contratados y sus características personales
- Modelos de clasificación para predecir el abandono (Churn) de los clientes
- Evaluación de campañas de retención a partir de los resultados de los modelos de
Churn.

-----------------------------------------------------------------------------------------------

# Importación de datos y librerías

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(width=100)

library(ggplot2)
library(dplyr)
library(readr)
library(reshape2)
library(GGally)
library(knitr)

```



```{r lectura_datos}
#churn_data<- read.csv("~/Rstudio/EJERCICIO FINAL/Telco-Customer-Churn.csv", sep=",")
churn_data<- read.csv("~/Ciencia del dato/Ejercicio Final CD/Telco-Customer-Churn.csv", sep=",")
str(churn_data)
summary(churn_data)
 head(churn_data)
```


# Análisis Exploratorio

Se detalla el significado preciso de las columnas del conjunto de datos

• customerID: Identificador de cliente


• gender: Varón(male) o mujer (female)

• SeniorCitizen: El cliente es de la tercera edad o no (1,0)

• Partner: El cliente tiene pareja o no (Yes,No)

• Dependents: El cliente tiene dependientes a su cargo o no (Yes,No)

• Tenure: Antigüedad en la compañía en meses

• PhoneService: El cliente tiene contratado servicio de teléfono o no (Yes, No)

• MultipleLines: El cliente tiene contratadas múltiples líneas (Yes, No, No phone service)

• InternetService: Tecnología de Internet contratada (DSL, Fiber optic, No)

• OnlineSecurity: El cliente tiene contratado el servicio de seguridad online (Yes, No, No
internet service)

• OnlineBackup: El cliente tiene contratado servicio de backup (Yes, No, No internet
service)

• DeviceProtection: El cliente tiene contratado el servicio de protección de dispositivos
(Yes, No, No internet service)

• TechSupport: El cliente tiene contratado el servicio de soporte técnico (Yes, No, No
internet service)

• StreamingTV: El cliente tiene contratado el servicio de TV en streaming (Yes, No, No
internet service)

• StreamingMovies: El cliente tiene contratado el servicio de películas en streaming (Yes,
No, No internet service)

• Contract: Duración del contrato (Month-to-month, One year, Two year)

• PaperlessBilling: El cliente recibe facture electrónica (Yes, No)

• PaymentMethod: Modo de pago (Electronic check, Mailed check, Bank transfer
(automatic), Credit card (automatic))

• MonthlyCharges: Tarifa mensual

• TotalCharges: Cargos totales facturados al cliente en todo el periodo de antigüedad

• Churn: El cliente ha abandonado la compañía en el mes en curso o no (Yes or No)



**Proporción de "churners" Variables cualitativas**
```{r Exploratorio de datos(subsección 1)1}

ggplot(churn_data) + geom_histogram(aes(SeniorCitizen, fill=Churn),binwidth = 5, position = "dodge") +
  scale_x_continuous() 

ggplot(churn_data) + geom_histogram(aes(tenure, fill=Churn),binwidth = 5, position = "stack", alpha=0.9) 
ggplot(churn_data) + geom_histogram(aes(MonthlyCharges, fill=Churn),binwidth = 5, position = "identity") 
ggplot(churn_data) + geom_histogram(aes(TotalCharges, fill=Churn), binwidth = 50, position = "identity")
```

**Variables cuantitativas**
```{r Exploratorio de datos(subsección 1)2}
var_cual<- churn_data[,-c(1,3,6,19,20)]
names(var_cual)
churn_melt<- melt(var_cual, measure.vars =  c("gender" ,  "Partner","Dependents","PhoneService","MultipleLines","InternetService","OnlineSecurity",  
"OnlineBackup","DeviceProtection" ,"TechSupport" ,"StreamingTV","StreamingMovies","Contract" , "PaperlessBilling",
"PaymentMethod" ), variable.name = "variables", value.name = "valor")
churn_melt %>% 
ggplot() + geom_bar(aes(valor,  fill=Churn),position = "dodge") + facet_wrap(~variables, scales = "free") 
```

 **Otra opción**
```{r Exploratorio de datos(subsección 1)3}
 for (i in names(var_cual)[-16]) {
  print(var_cual %>% 
    ggplot() + 
    geom_bar(aes_string(x = i, fill = "Churn"), position = "stack") +
    labs(x = i, y = "Count") +
    theme(axis.text.x = element_text(angle = 60)))
}
 
```
 



**Gasto mensual variables categóricas**
```{r Exploratorio de datos (subsección 2)1}

gasto_mens<-churn_data[,-c(1,3,6,20)]

var_cual_añad <- churn_data[,-c(1,3,6,20)]

for (i in names(var_cual_añad)[-16]) {
  print(var_cual_añad %>% 
    ggplot() + 
    geom_boxplot(aes(x = .data[[i]], y = MonthlyCharges, fill = .data[[i]])) +
    theme(legend.position = 'none'))
}


gasto_mens %>% ggplot() +
  geom_boxplot(aes(gender, MonthlyCharges))
gasto_mens %>% ggplot() +
  geom_boxplot(aes(MultipleLines, MonthlyCharges, fill=MultipleLines)) + theme(legend.position = 'none')
```

**Gasto mensual de las variables numéricas, correlación entre ellas**

```{r Exploratorio de datos (subsección 2)2}
churn_data %>%  
  ggpairs(columns = c(6,19,20)) 

```

**Transformación de variables necesarias**
```{r Exploratorio de datos (subsección 2)3}

churn_data$SeniorCitizen <- factor(churn_data$SeniorCitizen)
churn_data$SeniorCitizen <- ifelse(churn_data$SeniorCitizen== 1, "Yes", "No")
str(churn_data$SeniorCitizen)
class(churn_data$SeniorCitizen)

churn_data[, -c(1,6,19,20)]<-lapply(churn_data[, -c(1,6,19,20)], as.factor)
str(churn_data)
```

**Sugerencias**

```{r Exploratorio de datos (subsección 2)4}

long_contracts<-churn_data %>% filter( tenure>=12,InternetService !="No", PhoneService !="No", MultipleLines!="No", OnlineSecurity!="No", OnlineBackup!="No", DeviceProtection!="No", TechSupport!="No", StreamingTV!="No", StreamingMovies!="No") %>% 
  select(tenure, PhoneService, MultipleLines,InternetService,OnlineSecurity,OnlineBackup,DeviceProtection,TechSupport,StreamingTV,StreamingMovies,Churn, InternetService, Contract)


long_contracts %>% 
ggplot() + geom_bar(aes(Churn, fill=Contract), position = "dodge") +
  geom_text(data=NULL,x=2.6, y= 160, label="Los clientes con antiguedad mayor a 12 meses con todos los servicios contratados\n  se quedan en la compañía, sin embargo los que suelen tener contrato\n  mes a mes tienen riesgo de abandono.", vjust="top", hjust="right", size=3, color="black")

```


```{r Exploratorio de datos (subsección 2)5}

churn_data_numeric <- data.frame(lapply(churn_data[, -c(1)], as.numeric))
psych::corPlot(churn_data_numeric[,c(1,2,3,4,5,6,16,18,19,20)], min.length = 4, cex = 0.75, stars = TRUE)
psych::corPlot(churn_data_numeric, min.length = 3, numbers = FALSE)


```

*Esta correlación nos informa de tener menos probabilidad de abandono los clientes que tienen una antiguedad mayor, los cargos más altos de facturas si tienen riesgo de abandono, las tarifas mensuales más altas que conlleva a un total de cargos mayores tiene riesgo de abandono. *


```{r Exploratorio de datos (subsección 2)6, echo=FALSE}
datos <- churn_data[order(churn_data$tenure),]
datos$tenure_int <- cut(datos$tenure, 8)
long <- table(datos$tenure_int)
sum(long[1])
si_int1 <- sum(table(datos$Churn[datos$tenure_int=="(-0.072,9]"])[2])
prob1 <- si_int1 *100/long; prob1
nombres <- names(table(datos$tenure_int))
probabilidades <- c(rep(NA, 8))
si_int <- c(rep(NA, 8))
for (i in 1:length(nombres)) {
  si_int[i] <- sum(table(datos$Churn[datos$tenure_int==nombres[i]])[2])
  probabilidades[i] <- si_int[i]*100/sum(long[i])
}
dias <- nombres
dias[1] <- "[0,9]"
dias[2] <- "(10,18]"
tabla_pdias <- cbind(data.frame(dias, probabilidades))
str(tabla_pdias)
str(probabilidades)
str(dias)
tabla_pdias$dias <- factor(tabla_pdias$dias, levels = tabla_pdias$dias)

ggplot(tabla_pdias, aes(x=`dias`,y=`probabilidades`,fill=`dias`)) +
  labs(title="Probabilidad de abandono según la antigüedad") + xlab('Días en la compañía') +
  geom_bar(stat="identity") +
  scale_y_continuous(breaks=seq(0, 50,5)) +
  geom_text(aes(label = round(`probabilidades`,2)),vjust=1.5)
```

# Entrenamiento y testeo 


```{r train_test}


churn_train <- churn_data[1:5000,]
churn_test <- churn_data[-(1:5000),]

churn_mod<- churn_train[-c(1,20,21)]


```


# Modelos de Regresión Lineal

```{r Modelo Regresión Lineal}

modelo <- lm(MonthlyCharges~., data = churn_mod)
summary(modelo)

predict.test<- predict(modelo, newdata = churn_test)
rmse.test<- sqrt(mean((predict.test-churn_test$MonthlyCharges)^2))
```
Error cuadrático medio RMSE `r rmse.test`


# Modelos de clasificación

```{r Modelos de clasificación}

churn_train<- churn_train[,-c(1)]
mod_log<- glm(Churn ~., data = churn_train, family = binomial)
summary(mod_log)
prob<- predict(mod_log, type = "response", newdata=churn_test)
churn_pred<- ifelse( prob>0.5,"Yes", "No")
matriz_conf<-table(churn_test$Churn, churn_pred)
kable(matriz_conf)
er.clas<-(matriz_conf[1,2]+matriz_conf[2,1])/nrow(churn_test)


Accuracy<- (matriz_conf[1,1]+matriz_conf[2,2])/(matriz_conf[1,1] + matriz_conf[1,2] +   matriz_conf[2,2] + matriz_conf[2,1])
FPR<- (matriz_conf[1,2])/(matriz_conf[1,2]+ matriz_conf[1,1])
FNR<- (matriz_conf[2,1])/(matriz_conf[2,1] + matriz_conf[2,2])
TPR<- (matriz_conf[2,2])/ (matriz_conf[2,1]+ matriz_conf[2,2])


```


Error cuadrático medio `r round(er.clas,3)`

Precisión global de la predicción  `r round(Accuracy,3)`

Ratio falsos positivos  `r round(FPR,3)`

Ratio falsos negativos  `r round(FNR,3)`

Ratio verdaderos positivos `r round(TPR,3)`


**Otro modelo de clasificación**

```{r Otro modelo de clasificación}
mod2 <- glm(Churn~Contract + tenure + InternetService, data=churn_train, family = binomial)
(summary(mod2))
prob1<- predict(mod2, type = "response", newdata=churn_test);predict
churn_pred2<- ifelse( prob1>0.5,"Yes", "No")
t<- table(churn_test$Churn, churn_pred2)
kable(t)


er.2<- (t[1,2]+t[2,1])/nrow(churn_test)
Accuracy2<- (t[1,1]+t[2,2])/(t[1,1] + t[1,2] +   t[2,2] + t[2,1])
FPR2<- (t[1,2])/(t[1,2]+ t[1,1])
FNR2<- (t[2,1])/(t[2,1] + t[2,2])
TPR2<- (t[2,2])/ (t[2,1]+ t[2,2])

```

Error de clasificación `r round(er.2,3)`

Precisión global de la predicción  `r round(Accuracy2,3)`

Ratio falsos positivos  `r round(FPR2,3)`

Ratio falsos negativos  `r round(FNR2,3)`

Ratio verdaderos positivos `r round(TPR2,3)`

# Simulación de campaña de Retención

Vamos a calcular los resultados de la campaña para dos escenarios de incentivo distintos.

1) Supongamos:
- Coste teléfono de regalo: I=200 Eur
- Probabilidad de aceptación AR= 0.4
- R = 500 Eur

2) Supongamos:
- Coste teléfono: I=400 Eur
- Probabilidad de aceptación AR= 0.8
- R = 500 Eur


```{r Simulación campaña}
probs<-predict(mod_log, type="response", newdata=churn_test)
up<- seq(0,1,0.1)
pred_churn<- ifelse(probs>up,"Yes","No")
tb <- table(churn_test$Churn, pred_churn)
kable(tb)

fp <- c(rep(NA, 11))
fn <- c(rep(NA, 11))
tp <- c(rep(NA, 11))
ce <- c(rep(NA, 11))
cp <- c(rep(NA, 11))
for (i in 1:length(up)) {
  rm(clase, table)
  clase=factor(ifelse(probs>up[i], "Yes", "No"), levels = 
                  c("No", "Yes"))
  table <- table(churn_test$Churn, clase)
  fp[i] <- table[1,2]
  fn[i] <- table[2,1]
  tp[i] <- table[2,2]
  ce[i] <- (table[1,2] + table[2,1]) / sum(table)*100
  cp[i] <- sum(table[,2])/sum(table)*100
  
}

res <- cbind(data.frame(umbral = up, FP = fp, FN = fn, TP = tp, class_err = ce, classpos = cp))

ggplot(melt(res, id="umbral", measure=c("FP", "FN","class_err"))) +
  geom_line(aes(umbral, value, color=variable)) + xlim(0,1)





```



**Campaña incentivo 1**

```{r Campaña incentivo 1}
prob_umbral<- res[,1]
I_ <- 200
AR_ <- 0.4
R_ <- 500
simula_1 <- data.frame()

for (i in 1:length(prob_umbral)) {
  
  FN <- res[(i),"FN"]
  FP <- res[(i), "FP"]
  TP <- res[(i), "TP"]
  
  resconcamp_<- -FP*AR_*I_ - TP*AR_*I_ - TP*(1-AR_)*R_ - FN* R_
  ressincamp_<- -(FN + TP)*R_
  
  simula_1<- rbind(simula_1, data.frame(umbral=prob_umbral[i], ConCampaña=resconcamp_, SinCampaña=ressincamp_, beneficio= resconcamp_-ressincamp_)) 
}

umbral_optimo <- simula_1[which.max(simula_1$beneficio),1]
beneficio <- simula_1$beneficio[simula_1$umbral==umbral_optimo]

```

El umbral de clientes óptimo será `r umbral_optimo`

Generará un beneficio de `r (beneficio)` Euros


**Campaña incentivo 2**

```{r Camapaña incentivo 2}

I <- 400
AR<- 0.8
R<- 500

 simula_2<- data.frame()

for (i in 1:length(prob_umbral)) {
  FN <- res[(i),"FN"]
  FP <- res[(i), "FP"]
  TP <- res[(i), "TP"]

  resconcamp<- -FP*AR*I - TP*AR*I - TP*(1-AR)*R - FN* R
  ressincamp<- -(FN + TP)*R
  
  simula_2<- rbind(simula_2, data.frame(umbral=prob_umbral[i], resConCamp=resconcamp, resSinCamp=ressincamp, beneficio= resconcamp-ressincamp) )
}

umbral_optimo1 <- simula_2[which.max(simula_2$beneficio),1]; umbral_optimo1
beneficio1 <- simula_2$beneficio[simula_2$umbral==umbral_optimo1]

dif_bnf<- beneficio - beneficio1
```


El umbral de clientes óptimo será `r umbral_optimo1`.

Generará un beneficio de `r beneficio1` Euros.

Se optiene peor resultados respecto a la campaña con incentivo menor, con una diferencia de `r dif_bnf` Euros menos respecto a la campaña anterior. 


# Conclusión.

En este proyecto, hemos llevado a cabo un análisis exhaustivo del conjunto de datos "Telco Customer Churn" de una compañía de telecomunicaciones. Nuestro objetivo era comprender los factores que influyen en la tasa de abandono de clientes y predecir el gasto de los clientes, así como identificar a los clientes en riesgo de cambiar de compañía en el mes actual. También realizamos una simulación de campañas para retener a los clientes. Aquí está la respuesta a las preguntas planteadas:

_¿Cuáles son los motivos que llevan a los clientes a abandonar el servicio?_

Realizamos un análisis exploratorio de los datos que reveló correlaciones entre la antigüedad del cliente, los cargos mensuales y los totales. Los clientes con mayor antigüedad y cargos mensuales más altos tienen menos probabilidades de abandonar.

_¿Existe alguna relación entre el tiempo de contrato y la probabilidad de abandono?_

Descubrimos que los clientes con contratos a corto plazo (mes a mes) tenían un mayor riesgo de abandono en comparación con los contratos a largo plazo (uno o dos años).

_¿Cómo influye el tipo de servicio contratado en la tasa de abandono?_

Encontramos que ciertos servicios, como la fibra óptica, estaban relacionados con una mayor tasa de abandono, mientras que otros servicios como la seguridad en línea y el servicio de TV en streaming estaban asociados con una menor tasa de abandono.

_¿Cuán precisos son los modelos de predicción para identificar a los clientes con mayor probabilidad de abandonar?_

Creamos modelos de regresión lineal y modelos de clasificación para predecir el gasto mensual y la probabilidad de abandono. Evaluamos su precisión y calculamos métricas como el Error Cuadrático Medio (RMSE) y la Precisión Global de la Predicción. También analizamos los ratios de falsos positivos y falsos negativos.

_¿Qué campaña se ajusta más para evitar el abandono de nuestros clientes?_

Realizamos simulaciones de dos campañas de retención con diferentes niveles de incentivos. La primera campaña, con incentivos más bajos, resultó en un beneficio óptimo. La segunda campaña, con incentivos más altos, generó un beneficio menor en comparación con la primera campaña.

**En resumen, este proyecto proporciona información valiosa sobre cómo retener a los clientes y reducir la tasa de abandono. Se identificaron factores clave que influyen en la decisión de un cliente de abandonar, y se evaluaron estrategias de retención. Esto puede ayudar a la compañía de telecomunicaciones a tomar medidas proactivas para retener a sus clientes y mejorar su rentabilidad.**
